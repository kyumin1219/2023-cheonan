<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- css -->
    <link rel="stylesheet" href="./asset/css/app.css">
    <!-- css -->
    <!-- 스크립트 -->
    <script src='/asset/js/chart.umd.min.js'></script>
    <script src='/asset/js/jquery-3.5.1.min.js'></script>
    <script  src="/asset/js/app.js"></script>
    <!-- 스크립트 -->
</head>
<body>
    <!-- header -->
    <header>
        <div class="container fb mt2">
            <a href="./index.html" class="logo">logo</a>
            <nav class="fb">
                <div class="main f21 fb kr">
                    <a href="./mypage.html"><span></span>마이페이지</a>
                    <a href="./stamp.html"><span></span>명소알아보기</a>
                    <li><a href="./buy.html"><span></span>명물구매</a></li>
                    <a href="./sub.html"><span></span>셔틀버스 투어</a>
                </div>
                <div class="sub f18 fb kr">
                    <a href="./login.html">로그인</a>
                    <li class="aa"><span>|</span></li>
                    <a href="./signup.html">회원가입</a>
                </div>
            </nav>
        </div>
    </header>
    <!-- header -->
    
    <main class="tour mt20">
        <section class="cc">
            <div class="container mt8">
                <div class="middle">
                    <h2 class="title3">VISIT INFORMATION CHART</h2>
                    <div class="f hc mts">
                        <p class="f21 cp1">방문자 정보 차트</p>
                        <span></span>
                    </div>
                </div>
                <!-- 안에 차트들이 들어간다. -->
                <div class="box mt10 c4">
                    <!-- 위에 차트이동 탭 -->
                    <p class="chart_tab1 chart_tab check" onclick="tour.changeChart(1);">시간대별 방문자 차트</p>
                    <p class="chart_tab2 chart_tab" onclick="tour.changeChart(2);">8경별 총 방문자 차트</p>
                    <!-- 차트가 들어가 있다. -->
                    <div class="mt2 box1">
                        <div class="canvas1_box fb">
                            <!-- 막대 차트 -->
                            <div class="canvas canvas1" style="width: 850px; height: 600px;"></div>
                            <!-- 요일 탭 -->
                            <ul class="week rb f18">
                                <li class="check" onclick="tour.changeWeek(0);">월</li>
                                <li onclick="tour.changeWeek(1);">화</li>
                                <li onclick="tour.changeWeek(2);">수</li>
                                <li onclick="tour.changeWeek(3);">목</li>
                                <li onclick="tour.changeWeek(4);">금</li>
                                <li onclick="tour.changeWeek(5);">토</li>
                                <li onclick="tour.changeWeek(6);">일</li>
                                <div class="line"><div></div></div>
                            </ul>
                        </div>
                        <!-- 방사형 차트 -->
                        <div class="canvas canvas2 f" style="width: 500px;height: 600px; display: none;"></div>
                    </div>
                </div>

                <div class="middle mt10">
                    <h2 class="title3">VISIT INFORMATION MAP</h2>
                    <div class="f hc mts">
                        <p class="f21 cp1">명소 8경 지도</p>
                        <span></span>
                    </div>
                </div>
                <div class="f21 mt2 box2 fb" style="width: 1300px;">
                    <!-- 지도를 그린다. -->
                    <div class="fb" style="width: 800px;">
                        <div class="canvasMap mt2" style="position: relative;">
                            <!-- 지도 보여주기 -->
                            <canvas id="mapMy" width="800"height="850" style="width: 800px; height: 850px;"></canvas>
                            <!-- 지도안 마우스 오버가능한 명소들 -->
                            <div class="item1 item" onclick="clickPing(1);"></div>
                            <div class="item2 item" onclick="clickPing(2);"></div>
                            <div class="item3 item" onclick="clickPing(3);"></div>
                            <div class="item4 item" onclick="clickPing(4);"></div>
                            <div class="item5 item" onclick="clickPing(5);"></div>
                            <div class="item6 item" onclick="clickPing(6);"></div>
                            <div class="item7 item" onclick="clickPing(7);"></div>
                            <div class="item8 item" onclick="clickPing(8);"></div>
                            <!-- 지도안 마우스 오버시 보이는 명소들의 설명 -->
                            <div class="cc pop1">
                                <img src="./asset/img/명소/1경_독립기념관.jpg" alt="">
                                <p class="f14">독립기념관</p>
                            </div>
                            <div class="cc pop2">
                                <img src="./asset/img/명소/2경_유관순열사 사적지.jpg" alt="">
                                <p class="f14">유관순열사 사적지</p>
                            </div>
                            <div class="cc pop3">
                                <img src="./asset/img/명소/3경_천안 삼거리 공원.jpg" alt="">
                                <p class="f14">천안 삼거리 공원</p>
                            </div>
                            <div class="cc pop4">
                                <img src="./asset/img/명소/4경_태조산왕건길과 청동대좌불.jpg" alt="">
                                <p class="f14">태조산왕건길과 청동대좌불</p>
                            </div>
                            <div class="cc pop5">
                                <img src="./asset/img/명소/5경_아라리오조각광장.JPG" alt="">
                                <p class="f14">아라리오조각광장</p>
                            </div>
                            <div class="cc pop6">
                                <img src="./asset/img/명소/6경_성성호수공원.jpg" alt="">
                                <p class="f14">성성호수공원</p>
                            </div>
                            <div class="cc pop7">
                                <img src="./asset/img/명소/7경_광덕산.jpg" alt="">
                                <p class="f14">광덕산</p>
                            </div>
                            <div class="cc pop8">
                                <img src="./asset/img/명소/8경_국보 봉선홍경사갈기비.jpg" alt="">
                                <p class="f14">국보 봉선홍경사갈기비</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 기능들이 모여있는 btns -->
                    <div class="mt2" style="width: 400px;height: 150px; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 45px); gap: 20px; ">
                        <button class="btn" onclick="maketour.back();"><span>되돌리기</span></button>
                        <button class="btn" onclick="maketour.reset();"><span>초기화</span></button>
                        <a id="download" href="#" onclick="maketour.mapdownload();" class="btn" ><span>다운로드</span></a>
                        <button class="btn" onclick="maketour.endPing();"><span>가이드 선택</span></button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <!-- 콘텐트 -->
    <footer class="cc">
        <div class="container fb">
            <img src="./asset/img/logo(footer).png" alt="img" title="img">
            <div class="f18 mt1">
                <p class="mts">Call: 1422-36</p>
                <p class="mts">Email: help@cheonan.tour</p>
                <p class="mts">Address: (31162) 충남 천안시 서북구 번영로 156</p>
            </div>
            <p class="mt6 f18">Copyrightⓒ Cheonan-Si. All rights reserved.</p>
        </div>
    </footer>
    <script>
    $(()=>{
        // 페이지 로드시 시작
        tour.init();
        maketour.init();
    });
    // 캔버스 정의
    const canvas = document.getElementById('mapMy');
    const ctx = canvas.getContext("2d");
    // 이미지 정의
    const img = new Image();
    // 초기 기본 값 정의
    const rectangles = [
        {idx: 1, x: 385, y: 482, text:"독립기념관",  width: 30, height: 30, color: '#3b65ff', order: 0 },
        {idx: 2, x: 570, y: 505, text:"유관순열사 사적지",  width: 30, height: 30, color: '#3b65ff', order: 0 },
        {idx: 3, x: 280, y: 430, text:"천안 삼거리 공원",  width: 30, height: 30, color: '#3b65ff', order: 0 },
        {idx: 4, x: 355, y: 331, text:"태조산왕건길과 청동대좌불",  width: 30, height: 30, color: '#3b65ff', order: 0 },
        {idx: 5, x: 275, y: 331, text:"아라리오조각광장",  width: 30, height: 30, color: '#3b65ff', order: 0 },
        {idx: 6, x: 260, y: 264, text:"성성호수공원",  width: 30, height: 30, color: '#3b65ff', order: 0 },
        {idx: 7, x: 68, y: 658, text:"광덕산",  width: 30, height: 30, color: '#3b65ff', order: 0 },
        {idx: 8, x: 230, y: 68, text:"국보 봉선홍경사갈기비",  width: 30, height: 30, color: '#3b65ff', order: 0 },
    ];
    // 클릭된것을 담는다
    let clickedRectangles = [];
    // 현재 상태
    let state = true;
    // 끝났는가
    let end = true;

    const maketour = {
        // 시작 환경
        init(){
            clickedRectangles = [];
            end = true;
            state = true;
            rectangles.forEach(element => {
                element.order = 0;
            });
            maketour.seting();
        },
        // 항상 시작이 되는 세팅 값들(항상 실헹)
        seting(){
            img.src = '/asset/img/map.png';
            ctx.font = "18px Myraid-Pro bold";
            img.onload = function () {
                ctx.fillStyle = '#bbd5ff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                maketour.line();
                $(".canvasMap .item").text("");
                rectangles.forEach(rectangle => maketour.makePing(rectangle));
            }
        },
        // 라인 끗기
        line(){
            let how = 0;
            clickedRectangles.forEach(function(clickedRect){
                how = how + 1;
                if(clickedRectangles.length != 1 && clickedRectangles.length != how){
                    let prevRect = clickedRectangles[how];
                    ctx.beginPath();
                    // clickedRectangles[0];
                    ctx.moveTo(clickedRect.x + clickedRect.width / 2, clickedRect.y + clickedRect.height / 2);
                    // clickedRectangles[1];
                    ctx.lineTo(prevRect.x + prevRect.width / 2, prevRect.y + prevRect.height / 2);
                    ctx.strokeStyle = '#ff884d';
                    ctx.lineWidth = 5;
                    ctx.stroke();
                }
            } );
        },
        // 핑 그리기
        makePing(rectangle) {
            ctx.beginPath();
            ctx.fillStyle = rectangle.color;
            // ctx.fillRect(rectangle.x, rectangle.y, rectangle.width, rectangle.height);
            ctx.arc(rectangle.x + rectangle.width / 2, rectangle.y + rectangle.width / 2, rectangle.width / 2, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillStyle = 'white';
            // 0번째는 표시 하지 않기 위해서
            if(rectangle.order != 0){
                $(`.canvasMap .item${rectangle.idx}`).text(rectangle.order);
                ctx.fillText(rectangle.order, rectangle.x + 10, rectangle.y + rectangle.height - 10);
            }
        },
        // 실시간으로 연결되어 보여주는 라인(무우스를 따라감) 
        nowline(event){
            maketour.seting();
            setTimeout(() => {
                var prevRect = clickedRectangles[clickedRectangles.length - 1];
                ctx.beginPath();
                ctx.moveTo(prevRect.x + 15, prevRect.y + 15);
                let mouseX = event.clientX - canvas.getBoundingClientRect().left;
                let mouseY = event.clientY - canvas.getBoundingClientRect().top;
                ctx.lineTo(mouseX, mouseY);
                ctx.strokeStyle = '#ff884d';
                ctx.lineWidth = 5;
                ctx.stroke();
                rectangles.forEach(rectangle => maketour.makePing(rectangle));
            }, 0);
        },
        // 리셋 버튼 클릭시 실행
        reset(){
            if(clickedRectangles.length == 0) alert("초기화는 한번이상 클릭해야 작동합니다.");
            ctx.beginPath();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            maketour.init();
        },
        // 돌아가기 버튼을 누른다.
        back(){
            if(clickedRectangles.length == 0) alert("되돌리기는 한번이상 클릭해야 작동합니다.");
            state = false;
            clickedRectangles[clickedRectangles.length - 1].order = 0;
            clickedRectangles.pop();
            maketour.seting();
            end = true;
        },
        // 멥이 다운로드 된다.
        mapdownload(){
            if(state === true){
                alert("경로가 설정되어 있지 않습니다.");
            }else{
                $("#download").attr("href", $('#mapMy')[0].toDataURL("image/png"));
                $("#download").attr("download","route.png");
                $("download").trigger("click");
            }
        },
        // 경로 설정이 종료된다.
        endPing(){
            state = false;
            end = false;
            maketour.seting();
            alert("경로설정을 마쳤습니다. 수정하고 싶으면 되돌리거나 초기화 하십시오.");
        },
    }
    // 명소들을 마우스로 클릭시 발생된다.
    function clickPing(idx){
        // 끝이 났는가? (클릭이 활성화 된 상태에서 다음을 클릭하였는가)
        if(end){
            if(state || clickedRectangles.length == 0){
                maketour.seting();
                let temp = null;
                rectangles.forEach(element => {
                    if(element.idx == idx){
                        temp = element;
                    } 
                });
                // 이미 선택 된것인가 아닌가
                if (temp.order == 0) {
                    temp.order = clickedRectangles.length + 1;
                    clickedRectangles.push(temp);
                    state = true;
                    if (clickedRectangles.length != 1){
                        state = false;
                    }
                    if (clickedRectangles.length > 1) {
                        maketour.seting();
                    }
                    if(clickedRectangles.length == 8){
                        maketour.endPing();
                    }
                } else {
                    alert(`${rectangles[idx-1].text}는 선택할 수 없습니다.`);  
                }
            //  다음 클릭 활성화 시키기
            }else if(clickedRectangles[clickedRectangles.length - 1].idx == idx){
                state = true;
            // 조건에 충족하지 않기 때문에 alert를 띄워준다.
            }else{
                alert("마지막으로 설정한 경로가 아닙니다.");        
            }
        }
    }
    // 클릭된 상태에서 마우스 드레그시 마우스 포인트를 중심으로 라인이 그어져서 보인다. 
    $('.canvasMap').on("mousemove", e => {
        if (clickedRectangles.length > 0 && clickedRectangles.length < 8 && state == true) {
            maketour.nowline(e);
        }
    });
    </script>
</body>
</html>